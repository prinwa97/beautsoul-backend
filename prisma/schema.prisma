generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================
// Enums
// =============================

enum DistributorStatus {
  PENDING
  ACTIVE
}

enum RetailerStatus {
  PENDING
  ACTIVE
}

enum OrderStatus {
  SUBMITTED
  CONFIRMED
  REJECTED
  CANCELLED
  DISPATCHED
  DELIVERED
}

enum Role {
  ADMIN
  HR
  STATE_BUSINESS_HEAD
  SALES_MANAGER
  WAREHOUSE_MANAGER
  DISTRIBUTOR
  FIELD_OFFICER
  RETAILER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum InvoiceType {
  DISTRIBUTOR
  RETAILER
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

enum PaymentMode {
  CASH
  UPI
  BANK_TRANSFER
  CHEQUE
}

enum ShippingMode {
  COURIER
  TRANSPORT
  SELF
}

enum LedgerType {
  DEBIT
  CREDIT
}

enum OwnerType {
  COMPANY
  DISTRIBUTOR
  RETAILER
}

enum InboundOrderStatus {
  CREATED
  CONFIRMED
  PAYMENT_VERIFIED
  PACKED
  DISPATCHED
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum ReceiveStatus {
  RECEIVED
  PARTIAL_RECEIVED
}

// =============================
// Field Officer Gamification
// =============================

enum RewardRequestStatus {
  PENDING
  APPROVED
  REJECTED
  FULFILLED
}

enum InventoryTxnType {
  INBOUND
  RESERVE
  UNRESERVE
  DISPATCH
  RETURN
  DAMAGE
  ADJUSTMENT
  TRANSFER_OUT
  TRANSFER_IN
}

enum AuditStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  APPROVED
  CANCELLED
}

enum AuditMismatchType {
  SHORT
  EXCESS
  MATCH
}

enum AuditReason {
  DAMAGE
  EXPIRED_DISPOSAL
  SPILLAGE
  THEFT_LOSS
  MIS_PICK_MIS_ISSUE
  SUPPLIER_SHORT
  RETURN_PENDING
  DATA_ENTRY_ERROR
  OTHER
}

enum AuditRootCause {
  PROCESS
  DATA
  HANDLING
  SUPPLIER
  OTHER
}

enum AuditTaskStatus {
  OPEN
  DONE
}

enum AssignmentEventType {
  ASSIGN
  REASSIGN
  UNASSIGN
}

// =============================
// Core Models
// =============================

model User {
  id           String     @id @default(cuid())
  code         String     @unique
  name         String
  phone        String     @unique
  passwordHash String
  role         Role
  status       UserStatus @default(ACTIVE)

  address  String?
  city     String?
  district String?
  state    String?
  pincode  String?

  distributorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // FO ↔ Retailer assignment (Option A)
  foRetailerAssignments FieldOfficerRetailerMap[] @relation("FOAssignments")
  foRetailersAssigned   FieldOfficerRetailerMap[] @relation("AssignedByUser")

  // Option C assignment
  foRetailerActives    RetailerAssignmentActive[]  @relation("RetailerAssignmentActiveFo")
  assignedHistoryFrom  RetailerAssignmentHistory[] @relation("AssignHistoryFromFo")
  assignedHistoryTo    RetailerAssignmentHistory[] @relation("AssignHistoryToFo")
  assignedHistoryActor RetailerAssignmentHistory[] @relation("AssignHistoryActor")

  // Distributor owner profile (optional)
  distributorProfile Distributor? @relation("Distributor_userIdToUser")

  // Retailer profile (optional)
  retailer Retailer?

  // staff user working under a distributor
  distributor Distributor? @relation("DistributorStaff", fields: [distributorId], references: [id])

  // Sales manager → manages many distributors
  managedDistributors Distributor[] @relation("SalesManagerDistributors")

  // FO default for distributors
  defaultForDistributors Distributor[] @relation("DistributorDefaultFO")

  // Inbound audit trails
  inboundOrdersCreated     InboundOrder[]    @relation("InboundOrder_createdBy")
  inboundPaymentsEntered   InboundOrder[]    @relation("InboundOrder_paymentEnteredBy")
  inboundPaymentsVerified  InboundOrder[]    @relation("InboundOrder_paymentVerifiedBy")
  inboundDispatchesMarked  InboundOrder[]    @relation("InboundOrder_dispatchedBy")
  inboundDispatchesCreated InboundDispatch[] @relation("InboundDispatchCreatedBy")
  inboundReceivesReceived  InboundReceive[]  @relation("InboundReceive_receivedBy")

  // FO Gamification
  foMonthlyTargets FoMonthlyTarget[]
  foPointsLedger   FoPointsLedger[]
  foRewardRequests RewardRedeemRequest[]

  // FO Stock Audits
  foStockAudits RetailerStockAudit[] @relation("FOStockAudits")

  @@index([distributorId])
  @@index([role])
}

model Distributor {
  id    String  @id @default(cuid())
  code  String  @unique
  name  String
  phone String  @unique
  gst   String? @unique

  address  String?
  district String?
  city     String?
  state    String
  pincode  String?

  status DistributorStatus @default(PENDING)

  userId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // owner user (optional)
  user User? @relation("Distributor_userIdToUser", fields: [userId], references: [id])

  // Distributor business
  orders    Order[]
  retailers Retailer[]

  // staff under distributor
  staffUsers User[] @relation("DistributorStaff")

  // Option C assignment
  assignmentActives RetailerAssignmentActive[]
  assignmentHistory RetailerAssignmentHistory[]

  // Default FO
  defaultFoUserId String?
  defaultFoUser   User?   @relation("DistributorDefaultFO", fields: [defaultFoUserId], references: [id], onDelete: SetNull)

  // Sales manager mapping
  salesManagerId String?
  salesManager   User?   @relation("SalesManagerDistributors", fields: [salesManagerId], references: [id], onDelete: SetNull)

  // inbound flows
  inboundOrders   InboundOrder[]
  inboundReceives InboundReceive[]

  retailerLedger RetailerLedger[]
  invoices       Invoice[]

  @@index([status])
  @@index([salesManagerId])
  @@index([defaultFoUserId])
}

model Retailer {
  id     String @id @default(cuid())
  userId String @unique

  name  String
  phone String? @unique
  gst   String?

  address  String?
  city     String?
  district String?
  state    String?
  pincode  String?

  status RetailerStatus @default(PENDING)

  distributorId String?

  createdByRole Role
  createdById   String

  activatedByDistributorId String?
  activatedAt              DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  distributor Distributor? @relation(fields: [distributorId], references: [id])
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  ledgerEntries RetailerLedger[]
  invoices      Invoice[]

  stockAudits    RetailerStockAudit[]
  stockSnapshots RetailerStockSnapshot[]

  // Option C assignment
  assignmentActive  RetailerAssignmentActive?
  assignmentHistory RetailerAssignmentHistory[]

  // Option A assignment
  foAssignments FieldOfficerRetailerMap[] @relation("RetailerAssignments")

  @@index([distributorId])
  @@index([status])
}

model Order {
  id            String @id @default(uuid())
  orderNo       String @unique
  distributorId String
  retailerId    String

  status      OrderStatus @default(SUBMITTED)
  totalAmount Float       @default(0)
  paidAmount  Float       @default(0)

  createdAt DateTime @default(now())

  idempotencyKey    String?   @unique
  clientRequestHash String?
  deviceId          String?
  appVersion        String?
  requestReceivedAt DateTime?

  updatedAt DateTime @updatedAt

  distributor Distributor @relation(fields: [distributorId], references: [id])
  retailer    Retailer    @relation(fields: [retailerId], references: [id])

  items   OrderItem[]
  invoice Invoice?

  @@index([distributorId])
  @@index([retailerId])
  @@index([status])
  @@index([idempotencyKey])
  @@index([clientRequestHash])
}

model OrderItem {
  id          String @id @default(cuid())
  orderId     String
  productName String
  qty         Int
  rate        Float
  amount      Float

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productName])
}

model Inventory {
  id            String   @id @default(cuid())
  distributorId String
  productName   String
  qty           Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@unique([distributorId, productName])
  @@index([distributorId])
}

model Invoice {
  id        String @id @default(cuid())
  invoiceNo String @unique

  invoiceType InvoiceType @default(RETAILER)

  distributorId String
  retailerId    String?
  orderId       String? @unique

  totalAmount   Float         @default(0)
  paymentStatus PaymentStatus @default(UNPAID)
  paymentMode   PaymentMode?
  paidAmount    Float         @default(0)

  utrNo   String?
  paidAt  DateTime?
  remarks String?

  createdAt DateTime @default(now())

  distributor Distributor @relation(fields: [distributorId], references: [id])
  retailer    Retailer?   @relation(fields: [retailerId], references: [id])
  order       Order?      @relation(fields: [orderId], references: [id])

  items InvoiceItem[]

  @@index([distributorId])
  @@index([retailerId])
  @@index([invoiceType])
}

model InvoiceItem {
  id        String @id @default(cuid())
  invoiceId String

  productName String
  qty         Int
  rate        Float
  amount      Float

  batchNo    String
  mfgDate    DateTime?
  expiryDate DateTime

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([productName])
}

model InventoryBatch {
  id            String    @id @default(cuid())
  distributorId String
  productName   String
  batchNo       String
  mfgDate       DateTime?
  expiryDate    DateTime
  qty           Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ fixed naming
  txnBatchMaps InventoryTxnBatchMap[]

  @@unique([distributorId, productName, batchNo])
  @@index([distributorId])
  @@index([expiryDate])
}

model RetailerStockBatch {
  id         String @id @default(cuid())
  retailerId String

  productName String
  batchNo     String
  expiryDate  DateTime
  qty         Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([retailerId, productName, batchNo])
  @@index([retailerId])
  @@index([expiryDate])
}

model RetailerLedger {
  id            String @id @default(cuid())
  retailerId    String
  distributorId String

  date      DateTime   @default(now())
  type      LedgerType
  amount    Float
  reference String?
  narration String?

  createdAt DateTime @default(now())

  retailer    Retailer    @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)

  @@index([distributorId, date])
  @@index([retailerId, date])
  @@index([type])
}

// =============================
// Inbound Orders (Company → Distributor)
// =============================

model InboundOrder {
  id      String @id @default(cuid())
  orderNo String @unique

  forDistributorId String
  createdByUserId  String

  status InboundOrderStatus @default(CREATED)

  expectedAt DateTime?

  trackingCarrier String?
  trackingNo      String?
  trackingUrl     String?

  shippingMode  ShippingMode?
  courierName   String?
  transportName String?
  lrNo          String?
  dispatchDate  DateTime?

  paymentStatus  PaymentStatus @default(UNPAID)
  paymentMode    PaymentMode?
  paidAmount     Float         @default(0)
  utrNo          String?
  paidAt         DateTime?
  paymentRemarks String?

  paymentEnteredByUserId String?
  paymentEnteredBy       User?   @relation("InboundOrder_paymentEnteredBy", fields: [paymentEnteredByUserId], references: [id])

  paymentVerified         Boolean   @default(false)
  paymentVerifiedAt       DateTime?
  paymentVerifiedByUserId String?
  paymentVerifiedBy       User?     @relation("InboundOrder_paymentVerifiedBy", fields: [paymentVerifiedByUserId], references: [id])

  dispatchedAt       DateTime?
  dispatchedByUserId String?
  dispatchedBy       User?     @relation("InboundOrder_dispatchedBy", fields: [dispatchedByUserId], references: [id])

  dispatches InboundDispatch[] @relation("InboundOrderDispatches")

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  distributor Distributor @relation(fields: [forDistributorId], references: [id])
  createdBy   User        @relation("InboundOrder_createdBy", fields: [createdByUserId], references: [id])

  items    InboundOrderItem[]
  receives InboundReceive[]

  @@index([forDistributorId, status, createdAt])
  @@index([paymentStatus, paymentVerified])
  @@index([createdByUserId])
}

model InboundOrderItem {
  id             String @id @default(cuid())
  inboundOrderId String

  productName   String
  orderedQtyPcs Int
  rate          Float?
  batchNo       String?
  mfgDate       DateTime?
  expiryDate    DateTime?

  inboundOrder InboundOrder @relation(fields: [inboundOrderId], references: [id], onDelete: Cascade)

  @@index([inboundOrderId])
  @@index([productName])
}

model InboundReceive {
  id             String @id @default(cuid())
  inboundOrderId String
  distributorId  String

  status           ReceiveStatus
  receivedAt       DateTime      @default(now())
  receivedByUserId String

  inboundOrder InboundOrder @relation(fields: [inboundOrderId], references: [id], onDelete: Cascade)
  distributor  Distributor  @relation(fields: [distributorId], references: [id])
  receivedBy   User         @relation("InboundReceive_receivedBy", fields: [receivedByUserId], references: [id])

  items InboundReceiveItem[]

  @@index([distributorId, receivedAt])
  @@index([inboundOrderId])
}

model InboundReceiveItem {
  id               String @id @default(cuid())
  inboundReceiveId String

  productName    String
  orderedQtyPcs  Int
  receivedQtyPcs Int
  shortQtyPcs    Int

  inboundReceive InboundReceive @relation(fields: [inboundReceiveId], references: [id], onDelete: Cascade)

  @@unique([inboundReceiveId, productName])
  @@index([inboundReceiveId])
  @@index([productName])
}

model InboundDispatch {
  id              String  @id @default(cuid())
  inboundOrderId  String
  createdByUserId String?

  dispatchDate DateTime
  shippingMode ShippingMode
  carrierName  String
  trackingNo   String
  lrNo         String?

  parcels Int @default(1)

  driverName  String?
  driverPhone String?
  notes       String?

  createdAt DateTime @default(now())

  inboundOrder InboundOrder @relation("InboundOrderDispatches", fields: [inboundOrderId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("InboundDispatchCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  items InboundDispatchItem[]

  @@index([inboundOrderId, createdAt])
  @@index([trackingNo])
}

model InboundDispatchItem {
  id                 String @id @default(cuid())
  inboundDispatchId  String
  inboundOrderItemId String

  productName    String
  orderedQtyPcs  Int
  dispatchQtyPcs Int

  batchNo    String
  mfgDate    DateTime
  expiryDate DateTime

  inboundDispatch InboundDispatch @relation(fields: [inboundDispatchId], references: [id], onDelete: Cascade)

  @@index([inboundDispatchId])
  @@index([inboundOrderItemId])
}

// =============================
// Catalog + Lots + Rates
// =============================

model ProductCatalog {
  id        String  @id @default(cuid())
  name      String  @unique
  barcode   String? @unique
  hsn       String?
  mrp       Float?
  salePrice Float?
  gstRate   Float?
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([name])
}

model StockLot {
  id           String    @id @default(cuid())
  productName  String
  mfgDate      DateTime?
  ownerType    OwnerType
  ownerId      String?
  batchNo      String?
  expDate      DateTime?
  qtyOnHandPcs Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerType, ownerId, productName])
  @@index([expDate])
}

model DistributorProductRate {
  id            String @id @default(cuid())
  distributorId String
  productName   String
  saleRate      Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([distributorId, productName])
  @@index([distributorId])
  @@index([productName])
}

// =============================
// Inventory Snapshot + Txn (Batch maps)
// =============================

model InventorySnapshot {
  id            String   @id @default(cuid())
  distributorId String
  productName   String
  availableQty  Int      @default(0)
  reservedQty   Int      @default(0)
  updatedAt     DateTime @updatedAt

  @@unique([distributorId, productName])
  @@index([distributorId])
  @@index([productName])
}

model InventoryTxn {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  distributorId String
  productName   String
  type          InventoryTxnType

  qtyChange         Int
  qtyReservedChange Int @default(0)

  refType     String?
  refId       String?
  note        String?
  actorUserId String?
  actorRole   String?

  maps InventoryTxnBatchMap[]

  @@index([distributorId, createdAt])
  @@index([refType, refId])
  @@index([productName, createdAt])
}

model InventoryTxnBatchMap {
  id      String @id @default(cuid())
  txnId   String
  batchId String
  qtyUsed Int

  txn   InventoryTxn   @relation(fields: [txnId], references: [id], onDelete: Cascade)
  batch InventoryBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([txnId])
}

// =============================
// Warehouse Audit
// =============================

model StockAudit {
  id          String   @id @default(cuid())
  warehouseId String
  monthKey    String
  auditDate   DateTime
  snapshotAt  DateTime

  status AuditStatus @default(DRAFT)

  totalSystemQty   Int @default(0)
  totalPhysicalQty Int @default(0)
  totalVarianceQty Int @default(0)

  investigationQtyThreshold Int   @default(20)
  investigationPctThreshold Float @default(2.0)

  createdByUserId   String?
  submittedByUserId String?
  approvedByUserId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines StockAuditLine[]
  tasks StockAuditTask[]

  @@unique([warehouseId, monthKey])
  @@index([warehouseId, auditDate])
  @@index([status])
}

model StockAuditLine {
  id      String @id @default(cuid())
  auditId String

  audit StockAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  productName String
  batchNo     String?
  mfgDate     DateTime?
  expDate     DateTime?

  systemQty   Int
  physicalQty Int?
  diffQty     Int?

  mismatchType AuditMismatchType @default(MATCH)

  reason    AuditReason?
  rootCause AuditRootCause?
  remarks   String?

  needsInvestigation Boolean @default(false)
  isRepeatIssue      Boolean @default(false)
  evidenceUrl        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([auditId])
  @@index([productName])
  @@index([mismatchType])
  @@index([needsInvestigation])
}

model StockAuditTask {
  id      String @id @default(cuid())
  auditId String

  audit StockAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  title            String
  assignedToUserId String?
  dueDate          DateTime?
  status           AuditTaskStatus @default(OPEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([auditId])
  @@index([status])
}

model InventoryAdjustmentTxn {
  id          String @id @default(cuid())
  warehouseId String

  refType String
  refId   String

  productName String
  batchNo     String?
  deltaQty    Int

  reason      String?
  notes       String?
  actorUserId String?

  createdAt DateTime @default(now())

  @@index([warehouseId, createdAt])
  @@index([refType, refId])
}

// =============================
// FO Gamification
// =============================

model FoMonthlyTarget {
  id        String @id @default(cuid())
  foUserId  String
  monthKey  String
  targetAmt Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  foUser User @relation(fields: [foUserId], references: [id], onDelete: Cascade)

  @@unique([foUserId, monthKey])
  @@index([monthKey])
  @@index([foUserId])
}

model FoPointsLedger {
  id       String @id @default(cuid())
  foUserId String

  date   DateTime @default(now())
  type   String
  points Int

  reason   String?
  refType  String?
  refId    String?
  metaJson Json?

  foUser User @relation(fields: [foUserId], references: [id], onDelete: Cascade)

  @@index([foUserId, date])
  @@index([refType, refId])
}

model RewardCatalog {
  id         String  @id @default(cuid())
  title      String
  subtitle   String?
  pointsCost Int
  active     Boolean @default(true)
  imageUrl   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  requests RewardRedeemRequest[]

  @@index([active])
}

model RewardRedeemRequest {
  id       String @id @default(cuid())
  foUserId String
  rewardId String

  status RewardRequestStatus @default(PENDING)
  note   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  foUser User          @relation(fields: [foUserId], references: [id], onDelete: Cascade)
  reward RewardCatalog @relation(fields: [rewardId], references: [id], onDelete: Restrict)

  @@index([foUserId, createdAt])
  @@index([status])
  @@index([rewardId])
}

model SalesTarget {
  id             String  @id @default(uuid())
  month          String
  targetAmount   Int
  assignedById   String?
  fieldOfficerId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([month, fieldOfficerId])
}

// =============================
// Retailer Stock Audit + Snapshot
// =============================

model RetailerStockAudit {
  id             String @id @default(cuid())
  distributorId  String
  fieldOfficerId String
  retailerId     String

  auditDate DateTime @default(now())
  createdAt DateTime @default(now())

  retailer     Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  fieldOfficer User     @relation("FOStockAudits", fields: [fieldOfficerId], references: [id], onDelete: Cascade)

  items RetailerStockAuditItem[]

  @@index([distributorId, retailerId, auditDate])
  @@index([fieldOfficerId, auditDate])
}

model RetailerStockAuditItem {
  id      String @id @default(cuid())
  auditId String

  productName String
  batchNo     String?
  expiryDate  DateTime?

  systemQty   Int
  physicalQty Int
  variance    Int

  audit RetailerStockAudit @relation(fields: [auditId], references: [id], onDelete: Cascade)

  @@index([auditId])
  @@index([productName])
}

model RetailerStockSnapshot {
  id            String @id @default(cuid())
  distributorId String
  retailerId    String

  productName String
  batchNo     String?
  expiryDate  DateTime?
  qty         Int       @default(0)

  updatedAt DateTime @updatedAt

  // ✅ fixed field name (lowerCamelCase)
  retailer Retailer @relation(fields: [retailerId], references: [id])

  @@index([distributorId, retailerId])
  @@index([productName])
}

// =============================
// FO ↔ Retailer Assignment (Option A)
// =============================

model FieldOfficerRetailerMap {
  id         String @id @default(cuid())
  foUserId   String
  retailerId String

  // fast filters
  distributorId String?

  // who assigned (SM / Distributor / Admin)
  assignedByUserId String?
  assignedAt       DateTime  @default(now())
  unassignedAt     DateTime?
  isActive         Boolean   @default(true)

  note String?

  foUser   User     @relation("FOAssignments", fields: [foUserId], references: [id], onDelete: Cascade)
  retailer Retailer @relation("RetailerAssignments", fields: [retailerId], references: [id], onDelete: Cascade)

  assignedBy User? @relation("AssignedByUser", fields: [assignedByUserId], references: [id], onDelete: SetNull)

  @@unique([retailerId, isActive])
  @@index([foUserId, isActive])
  @@index([retailerId, isActive])
  @@index([distributorId, isActive])
}

model FieldOfficerTarget {
  id          String  @id @default(cuid())
  foUserId    String
  monthKey    String // YYYY-MM
  targetValue Float
  locked      Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([foUserId, monthKey])
  @@index([foUserId, monthKey])
}

// =============================
// Option C: Active + History
// =============================

model RetailerAssignmentActive {
  id            String @id @default(cuid())
  retailerId    String @unique
  foUserId      String
  distributorId String

  assignedByUserId String?
  assignedAt       DateTime @default(now())
  note             String?

  retailer    Retailer    @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  foUser      User        @relation("RetailerAssignmentActiveFo", fields: [foUserId], references: [id], onDelete: Cascade)
  distributor Distributor @relation(fields: [distributorId], references: [id], onDelete: Cascade)

  @@index([foUserId])
  @@index([distributorId])
}

model RetailerAssignmentHistory {
  id         String @id @default(cuid())
  retailerId String

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  fromFoUserId String?
  fromFoUser   User?   @relation("AssignHistoryFromFo", fields: [fromFoUserId], references: [id], onDelete: SetNull)

  toFoUserId String?
  toFoUser   User?   @relation("AssignHistoryToFo", fields: [toFoUserId], references: [id], onDelete: SetNull)

  distributorId String?
  distributor   Distributor? @relation(fields: [distributorId], references: [id], onDelete: SetNull)

  eventType AssignmentEventType
  reason    String?

  actorUserId String?
  actorUser   User?   @relation("AssignHistoryActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([retailerId, createdAt])
  @@index([distributorId, createdAt])
  @@index([actorUserId, createdAt])
}

model OrderRequestLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  endpoint  String
  requestId String?

  idempotencyKey    String  @unique
  clientRequestHash String?

  userId        String?
  retailerId    String?
  distributorId String?
  deviceId      String?

  result  String // "RECEIVED" | "CREATED" | "DEDUPED" | "ERROR"
  orderId String?
  error   String?
}
